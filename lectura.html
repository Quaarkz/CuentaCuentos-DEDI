<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pagina lectura de cuento">
    <title>Lectura</title>
    <link rel="stylesheet" href="css/lectura.css">

    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header principal -->
    <header class="header">
        <a href="index.html" class="header-title">Cuentacuentos</a>
    </header>

    <!-- Barra de acción -->
    <div id="action-bar" class="action-bar">
        <!-- Izquierda: Estado actual -->
        <div id="mode-indicator" class="mode-indicator">
            <img id="mode-icon" src="media/Book.png" alt="Modo Leyendo">
            <span id="mode-text">Leyendo...</span>
        </div>

        <!-- Centro: Título del cuento -->
        <a href="cuento.html" id="story-title" class="story-title">La Cenicienta</a>

        <!-- Derecha: Botón de cambio de modo -->
        <button id="toggle-mode" class="toggle-mode">
            <img id="toggle-icon" src="media/Speaker.png" alt="Cambiar a Escuchar">
        </button>
    </div>

    <!-- Contenido principal -->
    <main>
        <div id="story-content" class="story-content">
            <!-- Texto del cuento cargado dinámicamente -->
        </div>

        <!-- Botones de navegación -->
        <div id="navigation-buttons" class="navigation-buttons">
            <button id="prev-button" class="nav-button" disabled>
                <img src="media/prev-arrow.png" alt="Anterior">
            </button>
            <button id="next-button" class="nav-button" disabled>
                <img src="media/next-arrow.png" alt="Siguiente">
            </button>
        </div>
    </main>

    <!-- Controles para el modo Escuchar -->
    <div id="audio-controls" class="audio-controls" style="display: none;">
        <button id="btnPause" class="control-button">
            <img src="media/pause-icon.png" alt="Pausar">
        </button>
        <button id="btnPlay" class="control-button">
            <img src="media/play-icon.png" alt="Reproducir">
        </button>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');

        const modeIndicator = document.getElementById('mode-indicator');
        const modeIcon = document.getElementById('mode-icon');
        const modeText = document.getElementById('mode-text');
        const toggleModeButton = document.getElementById('toggle-mode');
        const toggleIcon = document.getElementById('toggle-icon');
        const storyContent = document.getElementById('story-content');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const audioControls = document.getElementById('audio-controls');
        const playButton = document.getElementById('btnPlay');
        const pauseButton = document.getElementById('btnPause');

        let storyLines = [];
        let currentIndex = 0;
        let utterance = null;

        // Función para cambiar entre modos
        const toggleMode = () => {
            if (action === 'leer') {
                window.location.href = 'lectura.html?action=escuchar';
            } else {
                window.location.href = 'lectura.html?action=leer';
            }
        };

        toggleModeButton.addEventListener('click', toggleMode);

        if (action === 'leer') {
            modeIcon.src = 'media/Book.png';
            modeText.textContent = 'Leyendo...';
            toggleIcon.src = 'media/Speaker.png';
            audioControls.style.display = 'none';

            fetch('books/Cenicienta.txt')
                .then(response => response.text())
                .then(data => {
                    storyLines = data.split('\n').filter(line => line.trim() !== '');
                    showLine();
                });

            const showLine = () => {
                storyContent.textContent = storyLines[currentIndex];
                prevButton.disabled = currentIndex === 0;
                nextButton.disabled = currentIndex === storyLines.length - 1;
            };

            prevButton.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    showLine();
                }
            });

            nextButton.addEventListener('click', () => {
                if (currentIndex < storyLines.length - 1) {
                    currentIndex++;
                    showLine();
                }
            });
        } else if (action === 'escuchar') {
            modeIcon.src = 'media/Speaker.png';
            modeText.textContent = 'Escuchando...';
            toggleIcon.src = 'media/Book.png';
            audioControls.style.display = 'flex';

            fetch('books/Cenicienta.txt')
                .then(response => response.text())
                .then(data => {
                    storyLines = data.split('\n').filter(line => line.trim() !== '');
                    playLine();
                });

            const playLine = () => {
                if (currentIndex < storyLines.length) {
                    utterance = new SpeechSynthesisUtterance(storyLines[currentIndex]);
                    utterance.lang = 'es-ES';

                    utterance.onend = () => {
                        currentIndex++;
                        if (currentIndex < storyLines.length) {
                            playLine();
                        } else {
                            storyContent.textContent = 'Lectura finalizada.';
                        }
                    };

                    speechSynthesis.speak(utterance);
                    storyContent.textContent = storyLines[currentIndex];
                }
            };

            playButton.addEventListener('click', () => {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                playLine();
            });

            pauseButton.addEventListener('click', () => {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
            });
        }
    </script>
</body>
</html>
