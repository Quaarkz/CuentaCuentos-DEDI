<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura</title>
    <link rel="stylesheet" href="css/lectura.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="header-title">Cuentacuentos</a>
    </header>
    <main>
        <h1 id="page-title"></h1>
        <p id="description"></p>
        <div id="story-content"></div>
        <div id="escuchar-container">
            <div id="texto-contenedor"></div>
            <div id="controls">
                <button id="btnPlay" class="action-button play">Play</button>
                <button id="btnPause" class="action-button pause">Pause</button>
            </div>
        </div>
        
        <div id="navigation-buttons">
            <button id="prev-button" disabled>Atrás</button>
            <button id="next-button">Siguiente</button>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const playButton = document.getElementById('btnPlay');
            const pauseButton = document.getElementById('btnPause');
            const textoContenedor = document.getElementById('texto-contenedor');
            let storyLines = [];
            let currentIndex = 0;
            let utterance = null;

            // Cargar voces disponibles
            function loadVoices() {
                return new Promise(resolve => {
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        resolve(voices);
                    } else {
                        speechSynthesis.onvoiceschanged = () => resolve(speechSynthesis.getVoices());
                    }
                });
            }

            // Actualizar línea visible en la pantalla
            function updateVisibleLine() {
                textoContenedor.textContent = storyLines[currentIndex];
            }

            // Manejar la lectura de líneas
            function readLine(voices) {
                if (currentIndex < storyLines.length) {
                    utterance = new SpeechSynthesisUtterance(storyLines[currentIndex]);
                    const elviraVoice = voices.find(
                        voice => voice.name === 'Microsoft Elvira Online (Natural) - Spanish (Spain)'
                    );
                    utterance.voice = elviraVoice || voices.find(voice => voice.lang === 'es-ES') || voices[0];
                    utterance.lang = "es-ES";

                    // Actualizar línea visible cuando inicie
                    utterance.onstart = () => {
                        updateVisibleLine();
                        console.log(`Leyendo línea ${currentIndex + 1}: ${storyLines[currentIndex]}`);
                    };

                    // Pasar a la siguiente línea al finalizar
                    utterance.onend = () => {
                        currentIndex++;
                        if (currentIndex < storyLines.length) {
                            readLine(voices);
                        } else {
                            console.log("Lectura completa.");
                        }
                    };

                    // Leer la línea actual
                    // Si deja de funcionar en Chrome añadir speechSynthesis.cancel()
                    speechSynthesis.speak(utterance);
                }
            }

            // Pausar o reanudar la lectura
            pauseButton.addEventListener('click', function () {
                if (speechSynthesis.speaking) {
                    if (speechSynthesis.paused) {
                        speechSynthesis.resume();
                    } else {
                        speechSynthesis.pause();
                    }
                }
            });

            // Manejar el botón Play
            playButton.addEventListener('click', async function () {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel(); // Reinicia la lectura //Sin esto no funciona fuera de Edge
                }

                // Cargar las voces
                const voices = await loadVoices();

                // Comenzar la lectura
                currentIndex = 0; // Reiniciar índice
                readLine(voices);
            });

            // Cargar el texto de Cenicienta.txt
            fetch('Cenicienta.txt')
                .then(response => response.text())
                .then(data => {
                    storyLines = data.split('\n').filter(line => line.trim() !== ''); // Filtrar líneas vacías
                    currentIndex = 0;
                    updateVisibleLine(); // Mostrar la primera línea en pantalla
                })
                .catch(error => console.error('Error al cargar el texto:', error));
        });
    </script>
</body>
</html>
