<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura</title>
    <link rel="stylesheet" href="css/lectura.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="header-title">Cuentacuentos</a>
    </header>
    <main>
        <h1 id="page-title"></h1>
        <p id="description"></p>
        <div id="story-content"></div>
        <div id="escuchar-container">
            <div id="texto-contenedor"></div>
            <div id="controls">
                <button id="btnPlay" class="action-button play">Play</button>
                <button id="btnPause" class="action-button pause">Pause</button>
            </div>
        </div>
        
        <div id="navigation-buttons">
            <button id="prev-button" disabled>Atrás</button>
            <button id="next-button" disabled>Siguiente</button>
        </div>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');

        const pageTitle = document.getElementById('page-title');
        const description = document.getElementById('description');
        const storyContent = document.getElementById('story-content');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const escucharContainer = document.getElementById('escuchar-container');
        const textoContenedor = document.getElementById('texto-contenedor');
        let storyLines = [];
        let currentIndex = 0;
        let utterance = null;

        // Cargar las voces disponibles
        function loadVoices() {
            return new Promise(resolve => {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                } else {
                    speechSynthesis.onvoiceschanged = () => resolve(speechSynthesis.getVoices());
                }
            });
        }

        if (action === 'leer') {
            pageTitle.textContent = "Lectura del Cuento";
            description.textContent = "Aquí tienes la historia de Cenicienta:";
            escucharContainer.style.display = 'none';

            fetch('Cenicienta.txt')
                .then(response => response.text())
                .then(data => {
                    storyLines = data.split('\n').filter(line => line.trim() !== ''); // Filtrar líneas vacías
                    showLine();
                })
                .catch(error => {
                    storyContent.textContent = 'Error al cargar el cuento. Por favor, inténtalo más tarde.';
                    console.error(error);
                });

            function showLine() {
                storyContent.textContent = storyLines[currentIndex];
                prevButton.disabled = currentIndex === 0;
                nextButton.disabled = currentIndex === storyLines.length - 1;
            }

            prevButton.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    showLine();
                }
            });

            nextButton.addEventListener('click', () => {
                if (currentIndex < storyLines.length - 1) {
                    currentIndex++;
                    showLine();
                }
            });
        }
        else if (action === 'escuchar') {
    pageTitle.textContent = "Escucha del Cuento";
    description.textContent = "Aquí tienes la historia de Cenicienta:";

    fetch('Cenicienta.txt')
        .then(response => response.text())
        .then(async data => {
            storyLines = data.split('\n').filter(line => line.trim() !== ''); // Filtrar líneas vacías
            currentIndex = 0;
            textoContenedor.textContent = storyLines[currentIndex]; // Mostrar la primera línea
            const voices = await loadVoices();

            let utterance = null;

            const playLine = () => {
                if (currentIndex < storyLines.length) {
                    // Configurar la síntesis para la línea actual
                    utterance = new SpeechSynthesisUtterance(storyLines[currentIndex]);
                    utterance.lang = "es-ES";
                    utterance.voice = voices.find(voice => voice.name === 'Microsoft Elvira Online (Natural) - Spanish (Spain)')
                        || voices.find(voice => voice.lang === 'es-ES') || voices[0];

                    // Mostrar la línea actual
                    textoContenedor.textContent = storyLines[currentIndex];

                    // Al terminar de leer esta línea, pasar a la siguiente
                    utterance.onend = () => {
                        currentIndex++;
                        if (currentIndex < storyLines.length) {
                            playLine(); // Leer la siguiente línea
                        } else {
                            textoContenedor.textContent = "Lectura finalizada.";
                        }
                    };

                    // Iniciar la lectura de la línea actual
                    speechSynthesis.speak(utterance);
                }
            };

            // Botón Play
            document.getElementById('btnPlay').addEventListener('click', () => {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel(); // Cancelar cualquier lectura previa
                }
                playLine(); // Comenzar o reanudar desde la línea actual
            });

            // Botón Pause
            document.getElementById('btnPause').addEventListener('click', () => {
                if (speechSynthesis.speaking) {
                    if (speechSynthesis.paused) {
                        speechSynthesis.resume();
                    } else {
                        speechSynthesis.pause();
                    }
                }
            });
        })
        .catch(error => {
            textoContenedor.textContent = 'Error al cargar el texto. Por favor, inténtalo más tarde.';
            console.error(error);
        });
}


        else {
            pageTitle.textContent = "Página de Lectura";
            description.textContent = "Elige si deseas leer o escuchar el cuento:";
            escucharContainer.style.display = 'none';
            prevButton.style.display = 'none';
            nextButton.style.display = 'none';

            const buttonContainer = document.createElement('div');
            buttonContainer.id = 'choice-buttons';

            const readButton = document.createElement('button');
            readButton.textContent = 'Leer Cuento';
            readButton.classList.add('action-button', 'read');
            readButton.addEventListener('click', () => {
                window.location.href = 'lectura.html?action=leer';
            });

            const listenButton = document.createElement('button');
            listenButton.textContent = 'Escuchar Cuento';
            listenButton.classList.add('action-button', 'listen');
            listenButton.addEventListener('click', () => {
                window.location.href = 'lectura.html?action=escuchar';
            });

            buttonContainer.appendChild(readButton);
            buttonContainer.appendChild(listenButton);
            description.after(buttonContainer);
        }
    </script>
</body>
</html>
