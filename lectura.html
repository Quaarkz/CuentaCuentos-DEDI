<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura</title>
    <link rel="stylesheet" href="css/lectura.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="header-title">Cuentacuentos</a>
    </header>
    <main>
        <h1 id="page-title"></h1>
        <p id="description"></p>
        <div id="story-content"></div>
        <div id="escuchar-container">
            <div id="texto-contenedor"></div>
            <div id="controls">
                <button id="btnPlay" class="action-button play">Play</button>
                <button id="btnPause" class="action-button pause">Pause</button>
            </div>
        </div>
        
        <div id="navigation-buttons">
            <button id="prev-button" disabled>Atrás</button>
            <button id="next-button">Siguiente</button>
        </div>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');

        const pageTitle = document.getElementById('page-title');
        const description = document.getElementById('description');
        const storyContent = document.getElementById('story-content');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const escucharContainer = document.getElementById('escuchar-container');

        let storyLines = [];
        let currentIndex = 0;

        // Cargar las voces solo cuando estén disponibles
        let voices = [];
        function loadVoices() {
            voices = speechSynthesis.getVoices();
            if (voices.length === 0) {
                speechSynthesis.addEventListener('voiceschanged', function() {
                    voices = speechSynthesis.getVoices();
                });
            }
        }

        if (action === 'leer') {
            pageTitle.textContent = "Lectura del Cuento";
            description.textContent = "Aquí tienes la historia de Cenicienta:";

            escucharContainer.style.display = 'none';

            fetch('Cenicienta.txt')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No se pudo cargar el cuento.');
                    }
                    return response.text();
                })
                .then(data => {
                    storyLines = data.split('\n');
                    showLine();
                })
                .catch(error => {
                    storyContent.textContent = 'Error al cargar el cuento. Por favor, inténtalo más tarde.';
                    console.error(error);
                });

            function showLine() {
                storyContent.textContent = storyLines[currentIndex];
                prevButton.disabled = currentIndex === 0;
                nextButton.disabled = currentIndex === storyLines.length - 1;
            }

            prevButton.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    showLine();
                }
            });

            nextButton.addEventListener('click', () => {
                if (currentIndex < storyLines.length - 1) {
                    currentIndex++;
                    showLine();
                }
            });
        }
        else if(action === 'escuchar') {
            pageTitle.textContent = "Escucha del Cuento";
            description.textContent = "Aquí tienes la historia de Cenicienta:";

            // Cargar las voces primero
            loadVoices();

            document.addEventListener('DOMContentLoaded', function () {
                const playButton = document.getElementById('btnPlay');
                const pauseButton = document.getElementById('btnPause');
                const textoContenedor = document.getElementById('texto-contenedor');
                let utterance = null;

                // Cargar el texto de Cenicienta.txt
                fetch('Cenicienta.txt')
                    .then(response => response.text())
                    .then(data => {
                        textoContenedor.textContent = data; // Mostrar el texto en la página
                    })
                    .catch(error => console.error('Error al cargar el texto:', error));

                // Manejar el botón Play
                playButton.addEventListener('click', function () {
                    const texto = textoContenedor.textContent.trim();

                    if (texto) {
                        // Crear un nuevo objeto SpeechSynthesisUtterance si no existe o si se detuvo
                        if (!utterance || speechSynthesis.paused || !speechSynthesis.speaking) {
                            utterance = new SpeechSynthesisUtterance(texto);
                            const spanishVoice = voices.find(voice => voice.lang === 'es-ES');
                            utterance.voice = spanishVoice || voices[0];
                            utterance.lang = "es-ES";

                            // Iniciar síntesis de voz
                            console.log(utterance);
                            utterance.onstart = () => {
                                console.log("La lectura ha comenzado.");
                            };

                            utterance.onend = () => {
                                console.log("La lectura ha terminado.");
                            };
                            speechSynthesis.cancel();
                            speechSynthesis.speak(utterance);
                        }
                    } else {
                        alert('No se pudo cargar el texto.');
                    }
                });

                // Manejar el botón Pause
                pauseButton.addEventListener('click', function () {
                    if (speechSynthesis.speaking && !speechSynthesis.paused) {
                        speechSynthesis.pause(); // Pausar la lectura
                    } else if (speechSynthesis.paused) {
                        speechSynthesis.resume(); // Reanudar la lectura
                    }
                });
            });

        }
        else {
            pageTitle.textContent = "Página de Lectura";
            description.textContent = "No sabemos cómo llegaste aquí, así que elige si leer o escuchar el cuento.";
            escucharContainer.style.display = 'none';

            prevButton.style.display = 'none';
            nextButton.style.display = 'none';

            // Crear contenedor para los botones
            const buttonContainer = document.createElement('div');
            buttonContainer.id = 'choice-buttons';

            // Crear botón "Leer"
            const readButton = document.createElement('button');
            readButton.textContent = 'Leer Cuento';
            readButton.classList.add('action-button', 'read');
            readButton.addEventListener('click', () => {
                window.location.href = 'lectura.html?action=leer';
            });

            // Crear botón "Escuchar"
            const listenButton = document.createElement('button');
            listenButton.textContent = 'Escuchar Cuento';
            listenButton.classList.add('action-button', 'listen');
            listenButton.addEventListener('click', () => {
                window.location.href = 'lectura.html?action=escuchar';
            });

            // Añadir botones al contenedor
            buttonContainer.appendChild(readButton);
            buttonContainer.appendChild(listenButton);

            // Añadir contenedor al DOM
            description.after(buttonContainer);
        }

    </script>
</body>
</html>
