<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura</title>
    <link rel="stylesheet" href="css/lectura.css">
</head>
<body>
    <header class="header">
        <a href="index.html" class="header-title">Cuentacuentos</a>
    </header>
    <main>
        <h1 id="page-title"></h1>
        <div id="description-container" style="position: relative; display: inline-block;">
            <p id="description">Aquí tienes la historia de Cenicienta:</p>
            <img id="speaking-icon" src="media/speaking.png" alt="Speaking Icon" style="display: none;">
        </div>
        
        <div id="story-content"></div>
        <div id="escuchar-container" style="position: relative;">
            <div id="texto-contenedor"></div>
            <div id="controls">
                <button id="btnPlay" class="action-button play">Comenzar a escuchar</button>
                <button id="btnPause" class="action-button pause">Pausar</button>
            </div>
        </div>

        <div id="navigation-buttons">
            <button id="prev-button" disabled>Atrás</button>
            <button id="next-button" disabled>Siguiente</button>
        </div>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const action = params.get('action');

        const pageTitle = document.getElementById('page-title');
        const description = document.getElementById('description');
        const storyContent = document.getElementById('story-content');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const escucharContainer = document.getElementById('escuchar-container');
        const textoContenedor = document.getElementById('texto-contenedor');
        const navigationContainer = document.getElementById('navigation-buttons');
        let storyLines = [];
        let currentIndex = 0;
        let utterance = null;

        // Cargar las voces disponibles
        function loadVoices() {
            return new Promise(resolve => {
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                } else {
                    speechSynthesis.onvoiceschanged = () => resolve(speechSynthesis.getVoices());
                }
            });
        }

        if (action === 'leer') {
            pageTitle.textContent = "Lectura del Cuento";
            description.textContent = "Aquí tienes la historia de Cenicienta:";
            escucharContainer.style.display = 'none';

            fetch('books/Cenicienta.txt')
                .then(response => response.text())
                .then(data => {
                    storyLines = data.split('\n').filter(line => line.trim() !== ''); // Filtrar líneas vacías
                    showLine();
                })
                .catch(error => {
                    storyContent.textContent = 'Error al cargar el cuento. Por favor, inténtalo más tarde.';
                    console.error(error);
                });

            function showLine() {
                storyContent.textContent = storyLines[currentIndex];
                prevButton.disabled = currentIndex === 0;
                nextButton.disabled = currentIndex === storyLines.length - 1;
            }

            prevButton.addEventListener('click', () => {
                if (currentIndex > 0) {
                    currentIndex--;
                    showLine();
                }
            });

            nextButton.addEventListener('click', () => {
                description.style.display = "none"
                if (currentIndex < storyLines.length - 1) {
                    currentIndex++;
                    showLine();
                }
            });
        }
        else if (action === 'escuchar') {
            pageTitle.textContent = "Escucha del Cuento";
            description.textContent = "Aquí tienes la historia de Cenicienta:";
            navigationContainer.style.display = 'none';

            const speakingIcon = document.getElementById('speaking-icon');

            fetch('books/Cenicienta.txt')
                .then(response => response.text())
                .then(async data => {
                    storyLines = data.split('\n').filter(line => line.trim() !== '');
                    currentIndex = 0;
                    textoContenedor.textContent = storyLines[currentIndex];
                    const voices = await loadVoices();

                    let utterance = null;

                    const playLine = () => {
                        if (currentIndex < storyLines.length) {
                            utterance = new SpeechSynthesisUtterance(storyLines[currentIndex]);
                            utterance.lang = "es-ES";
                            utterance.voice = voices.find(voice => voice.name === 'Microsoft Elvira Online (Natural) - Spanish (Spain)') 
                                || voices.find(voice => voice.lang === 'es-ES') || voices[0];

                            textoContenedor.textContent = storyLines[currentIndex];

                            utterance.onstart = () => {
                                speakingIcon.style.display = 'block'; // Mostrar el icono al iniciar
                            };

                            utterance.onend = () => {
                                //speakingIcon.style.display = 'none'; 
                                //Ocultar el icono al finalizar pero tambien se oculta al final de cada linea
                                currentIndex++;
                                if (currentIndex < storyLines.length) {
                                    playLine();
                                } else {
                                    textoContenedor.textContent = "Lectura finalizada.";
                                }
                            };

                            speechSynthesis.speak(utterance);
                        }
                    };

                    document.getElementById('btnPlay').addEventListener('click', () => {
                        if (speechSynthesis.speaking) {
                            speechSynthesis.cancel();
                        }
                        playLine();
                    });

                    document.getElementById('btnPause').addEventListener('click', () => {
                        if (speechSynthesis.speaking) {
                            if (speechSynthesis.paused) {
                                speechSynthesis.resume();
                                speakingIcon.style.display = 'block'; // Mostrar el icono al reanudar
                            } else {
                                speechSynthesis.pause();
                                speakingIcon.style.display = 'none'; // Ocultar el icono al pausar
                            }
                        }
                    });
                })
                .catch(error => {
                    textoContenedor.textContent = 'Error al cargar el texto. Por favor, inténtalo más tarde.';
                    console.error(error);
                });
        }

        else {
            pageTitle.textContent = "Página de Lectura";
            description.textContent = "Elige si deseas leer o escuchar el cuento:";
            escucharContainer.style.display = 'none';
            prevButton.style.display = 'none';
            nextButton.style.display = 'none';

            const buttonContainer = document.createElement('div');
            buttonContainer.id = 'choice-buttons';

            const readButton = document.createElement('button');
            readButton.textContent = 'Leer Cuento';
            readButton.classList.add('action-button', 'read');
            readButton.addEventListener('click', () => {
                window.location.href = 'lectura.html?action=leer';
            });

            const listenButton = document.createElement('button');
            listenButton.textContent = 'Escuchar Cuento';
            listenButton.classList.add('action-button', 'listen');
            listenButton.addEventListener('click', () => {
                window.location.href = 'lectura.html?action=escuchar';
            });

            buttonContainer.appendChild(readButton);
            buttonContainer.appendChild(listenButton);
            description.after(buttonContainer);
        }
    </script>
</body>
</html>
